[id="ref-controller-organization-mapping"]

= Organization mapping

You must control which users are placed into which {ControllerName} organizations based on their username and email address (distinguishing your organization administrators and users from social or enterprise-level authentication accounts).

Dictionary keys are organization names. 
Organizations are created, if not already present, and if the license permits multiple organizations. 
Otherwise, the single default organization is used regardless of the key.

Values are dictionaries defining the options for each organization's membership. 
For each organization, you can specify which users are automatically users of the organization and also which users can administer the organization.

*admins*: None, True/False, string or list/tuple of strings:

* If *None*, organization administrators are not updated.
* If *True*, all users using account authentication are automatically added as administrators of the organization.
* If *False*, no account authentication users are automatically added as administrators of the organization.
* If a string or list of strings, specifies the usernames and emails for users to be added to the organization, strings beginning and ending with `/` are compiled into regular expressions.
The modifiers `i` (case-insensitive) and `m` (multi-line) can be specified after the ending `/`.

*remove_admins*: True/False. Defaults to *True*:

* When *True*, a user who does not match is removed from the organization's administrative list.
* *users*: None, True/False, string or list/tuple of strings. The same rules apply as for *admins*.
* *remove_users*: True/False. Defaults to *True*. The same rules apply as for *remove_admins*.

[literal, options="nowrap" subs="+attributes"]
----
{
    "Default": {
        "users": true
    },
    "Test Org": {
        "admins": ["admin@example.com"],
        "users": true
    },
    "Test Org 2": {
        "admins": ["admin@example.com", "/^controller-[^@]+?@.*$/i"],
        "users": "/^[^@].*?@example\\.com$/"
    }
}
----

Organization mappings can be specified separately for each account authentication backend. 
If defined, these configurations take precedence over the global configuration above.

[literal, options="nowrap" subs="+attributes"]
----
SOCIAL_AUTH_GOOGLE_OAUTH2_ORGANIZATION_MAP = {}
SOCIAL_AUTH_GITHUB_ORGANIZATION_MAP = {}
SOCIAL_AUTH_GITHUB_ORG_ORGANIZATION_MAP = {}
SOCIAL_AUTH_GITHUB_TEAM_ORGANIZATION_MAP = {}
SOCIAL_AUTH_SAML_ORGANIZATION_MAP = {}
----

.remove_auditors

Before {PlatformNameShort} {PlatformVers}, *System Auditor* rights were revoked when logging in using Single Sign-On (SSO).
The user system auditor role was reset at login for SAML users when added in the {PlatformNameShort} user interface.

In {PlatformNameShort} {PlatformVers}, you can set a new special user flag to not remove system auditors when logging in, if you added the role in the user interface.

To enable this functionality:

. From the navigation panel, select {MenuAEAdminSettings}.
. Select *SAML settings* from the list of *Authentication* options.
. Click btn:[Edit] and update the *SAML Organization Attribute Mapping* to `{"remove_auditors": false}`.
+
.Example
+
[literal, options="nowrap" subs="+attributes"]
+
----
{ "remove": true, "remove_admins": false, 
"remove_auditors": false, "saml_admin_attr": 
"admin-of", "saml_attr": "organizations" }
----

.Verification

. Enable debugging in {ControllerName}.
** From the navigation panel, select {MenuAEAdminSettings}.
** Select *Logging settings* from the list of *System* options.
** Click btn:[Edit] and select *Debug* in the *Logging Aggregator Level Threshold* drop-down menu.
. Use SSO to log in to an account with *System Auditor* privileges.
. Verify the results in `/var/log/tower/tower.log`. 
Or if you are running {PlatformNameShort} on {OCPShort}, review the web pod logs and look for the following, which occurs when a system auditor logs in, whose role was removed when logging in:
+
[literal, options="nowrap" subs="+attributes"]
+
----
2025-01-17 14:19:36,624 DEBUG 
[7d3cf3b24d4e4d0e9edd5e2606d6ceba] awx.sso.common 
SAML adapter removing user auditor1 permission of 
auditor_role from organization Default
----
